(()=>{"use strict";"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const a=16*Math.random()|0;return("x"===e?a:3&a|8).toString(16)}));jQuery((function(e){const{env:a,locale:t,confirmationUrl:r,isOrderPayPage:n}=awxCommonData,i=n?"#order_review":"form.checkout",{autoCapture:c,errorMessage:l,incompleteMessage:o}=awxEmbeddedCardData,d=function(a){let t=e('input[name="save-card"]:checked').attr("id");return t&&(a+=a?"&":"",a+="token="+t),a};let s,m,u=[],x=!0;const w=()=>{m=Airwallex.createElement("card",{autoCapture:c,allowedCardNetworks:["discover","visa","mastercard","maestro","unionpay","amex","jcb","diners"],style:{base:{fontSize:"14px","::placeholder":{color:"rgba(135, 142, 153, 1)"}}}});let e=m.mount("airwallex-card");setInterval((function(){if(document.getElementById("airwallex-card")&&!document.querySelector("#airwallex-card iframe"))try{e=m.mount("airwallex-card")}catch(e){console.warn(e)}}),1e3),window.addEventListener("onError",(e=>{if(!e.detail)return;const{error:a}=e.detail;AirwallexClient.displayCheckoutError(i,String(l).replace("%s",a.message||""))})),f()},p=e=>{try{var a=JSON.parse(e);return a&&"object"==typeof a}catch(e){return!1}},h=e=>{if(-1===navigator.userAgent.indexOf("MSIE")&&!document.documentMode)return!0;e.preventDefault()};e("form.checkout").on("checkout_place_order_airwallex_card",(function(){let a=e(this);return a.addClass("processing"),e.ajaxSetup({dataFilter:function(e,a){if("json"!==a)return e;if(p(e))return e;var t=e.match(/{"result.*}/);return null===t||p(t[0])&&(e=t[0]),e}}),_(i),e.ajax({type:"POST",url:awxEmbeddedCardData.getCheckoutAjaxUrl,data:d(a.serialize()),dataType:"json"}).done((function(a){if(h(),e(".checkout-inline-error-message").remove(),"success"!==a.result){let e="Error processing checkout. Please try again.";return a.messages&&"string"==typeof a.messages&&(e=a.messages),void AirwallexClient.displayCheckoutError(i,e)}g(a,m)})).fail((function(a){e(i).unblock(),h(),AirwallexClient.displayCheckoutError(i,a.responseText)})),!1}));const y=async a=>{let t=await e.ajax({type:"GET",url:awxEmbeddedCardData.getCustomerClientSecretAjaxUrl});return await Airwallex.createPaymentConsent({customer_id:t.customer_id,client_secret:t.client_secret,element:m,next_triggered_by:a,currency:awxEmbeddedCardData.currency})};e(document.body).on("click","#place_order",(async function(a){if("airwallex_card"===e('input[name="payment_method"]:checked').val()){if(awxEmbeddedCardData.isAccountPage){a.preventDefault(),_("#payment");let t=e(".awx-alert");t.hide();try{await y("customer")}catch(a){let r=a.message;return"resource_already_exists"===a.code&&(r=awxEmbeddedCardData.resourceAlreadyExistsMessage),e(".awx-alert .body").html(r),t.show(),void e("#payment").unblock()}return e("#add_payment_method").submit(),void e("#payment").unblock()}if(awxCommonData.isOrderPayPage){if(a.preventDefault(),window.location.search.includes("change_payment_method")){a.preventDefault();let t=e(".awx-alert");t.hide(),e("#place_order").prop("disabled",!0);try{let a=await y("merchant");const t=e("#order_review");t.find('input[name="is_change_payment_method"], input[name="awx_customer_id"], input[name="awx_consent_id"]').remove();[{name:"is_change_payment_method",value:"true"},{name:"awx_customer_id",value:a.customer_id},{name:"awx_consent_id",value:a.payment_consent_id}].forEach((a=>{e("<input>",{type:"hidden",name:a.name,value:a.value}).appendTo(t)})),t.trigger("submit")}catch(a){let r=a.message;return e(".awx-alert .body").html(r),t.show(),void e("#place_order").prop("disabled",!1)}return}_(i),e.ajax({type:"POST",data:d(e("#order_review").serialize()),url:awxCommonData.processOrderPayUrl}).done((a=>{"success"===a.result?g(a,m):(e("#order_review").unblock(),AirwallexClient.displayCheckoutError(i,String(l).replace("%s",a.error||"")))})).fail((a=>{e("#order_review").unblock(),AirwallexClient.displayCheckoutError(i,String(l).replace("%s",a.message||""))}))}}}));const _=a=>{setTimeout((function(){e(a).block({message:null,overlayCSS:{background:"#fff",opacity:.6}})}),50)},g=async(a,t)=>{if(!a||a.error)return AirwallexClient.displayCheckoutError(i,String(l).replace("%s","")),void e(i).unblock();if(a.redirect)-1===a.redirect.indexOf("https://")||-1===a.redirect.indexOf("http://")?window.location=a.redirect:window.location=decodeURI(a.redirect);else{try{if(a.paymentMethodId){if(!x&&!awxEmbeddedCardData.isSkipCVCEnabled)return AirwallexClient.displayCheckoutError(i,awxEmbeddedCardData.CVCIsNotCompletedMessage),void e(i).unblock();let t={client_secret:a.clientSecret,billing:AirwallexClient.getBillingInformation(),customer_id:a.customerId,intent_id:a.paymentIntent,payment_method_id:a.paymentMethodId,payment_method_options:{card:{auto_capture:c}}};a.createConsent&&(t.currency=a.currency,t.payment_consent={merchant_trigger_reason:"scheduled",next_triggered_by:"merchant"}),await s.confirm(t)}else a.createConsent?await Airwallex.createPaymentConsent({intent_id:a.paymentIntent,customer_id:a.customerId,client_secret:a.clientSecret,currency:a.currency,element:t,next_triggered_by:"merchant",billing:AirwallexClient.getBillingInformation()}):e("#airwallex-save").prop("checked")?await Airwallex.createPaymentConsent({intent_id:a.paymentIntent,customer_id:a.customerId,client_secret:a.clientSecret,currency:a.currency,element:t,next_triggered_by:"customer",billing:AirwallexClient.getBillingInformation()}):await Airwallex.confirmPaymentIntent({element:t,intent_id:a.paymentIntent,client_secret:a.clientSecret,payment_method:{card:{name:AirwallexClient.getCardHolderName()},billing:AirwallexClient.getBillingInformation()}})}catch(a){if("invalid_status_for_operation"!==a.code)return AirwallexClient.displayCheckoutError(i,String(l).replace("%s",a.message||"")),void e(i).unblock()}location.href=function(e,a,t){const r=new URL(e),n=new URLSearchParams(r.search);n.set("order_id",a),n.set("intent_id",t);const i=document.getElementById("airwallex-save");return i&&i.checked&&n.set("is_airwallex_save_checked","true"),r.search=n.toString(),r.toString()}(r,a.orderId,a.paymentIntent)}};awxCommonData&&((e,a,t)=>{const r=setInterval((()=>{window.Airwallex&&(clearInterval(r),Airwallex.init({env:e,locale:a,origin:window.location.origin}),t())}),1e3)})(a,t,w);const v=function(){e(".airwallex-container .new-card, .save-card input").removeAttr("checked"),e(".airwallex-container .save-card input").removeAttr("checked"),e(".airwallex-container .new-card-title, #airwallex-card, .line.save, .cvc-title, .cvc-container").hide(),e(".airwallex-container .save-card label").css("font-weight",400)};e(document).on("change",'input[name="save-card"]',(function(){v(),e(this).prop("checked",!0),e("#airwallex-new-card").removeAttr("checked"),e(".cvc-title, .cvc-container").hide(),e(".airwallex-container label").css("font-weight",400);let a=e('input[name="save-card"]:checked').attr("id");e('label[for="'+a+'"]').css("font-weight",700);let t=e(".save-card-"+a+" .cvc-title, .save-card-"+a+" .cvc-container");u?.[a]?.is_hide_cvc_element?t.hide():t.show();let r=3;["amex","american express"].includes(u?.[a]?.type?.toLowerCase())&&(r=4),s&&Airwallex.destroyElement("cvc"),s=Airwallex.createElement("cvc",{style:{base:{fontSize:"14px","::placeholder":{color:"rgba(135, 142, 153, 1)"}}},placeholder:awxEmbeddedCardData.CVC,cvcLength:r}),s.mount(a+"-cvc",{autoCapture:c}),x=!0,u?.[a]?.is_hide_cvc_element||(x=!1,s.on("change",(e=>{x=e.detail.complete})))})),e(document).on("change",'input[name="new-card"]',(function(){v(),e(".new-card-title, #airwallex-card, .line.save").show(),e('label[for="airwallex-new-card"]').css("font-weight",700)}));let f=async()=>{if(!e("#payment_method_airwallex_card").is(":checked"))return;if(!e(".airwallex-container .save-cards").length)return;if(!u||!Object.keys(u).length){_("#payment");let a=await e.ajax({type:"GET",url:awxEmbeddedCardData.getTokensAjaxUrl});e("#payment").unblock(),u=a.tokens}if(e(".payment_method_airwallex_card .wc-awx-checkbox-spinner").hide(),!u||!Object.keys(u).length)return e(".airwallex-container").show(),void e(".airwallex-container .new-card").hide();let a="";for(let e of Object.values(u)){let t=e.type.toLowerCase().replace(/\s+/g,"");"americanexpress"===t&&(t="amex"),"dinersclub"===t&&(t="diners"),a+=`       \n                <div class="save-card save-card-${e.id}">\n                    <div class="save-card-information line">\n                        <input type="radio" name="save-card" id="${e.id}"> \n                        <label for="${e.id}">\n                            <span>${e.formatted_type} •••• ${e.last4} (expires ${e.expiry_month}/${e.expiry_year.slice(-2)})</span> \n                            <img src="${awxEmbeddedCardData.cardLogos["card_"+t]}" class="airwallex-card-icon" alt="Credit Card">\n                        </label> \n                    </div>\n                    <div class="cvc-title" style="display: none;">Security code</div>   \n                    <div id="${e.id}-cvc" class="cvc-container" style="display: none;"></div>    \n                </div>\n            `}e(".airwallex-container").show(),e(".airwallex-container .save-cards").html(a),e(".airwallex-container .new-card").show(),e('input[name="save-card"]').first().trigger("click")};e(document).on("change","#payment_method_airwallex_card",f),e(document).on("updated_checkout",f)}))})();